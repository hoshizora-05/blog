<!doctype html>
<html lang="ja-jp">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>杜と星の日記帳</title>
    <link rel="stylesheet" href="/css/ress.css">
    <link rel="stylesheet" href="/css/web240417.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/default.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kosugi&family=M+PLUS+2&family=Sawarabi+Gothic&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet">
  </head>
  <body>
    <div class="grid">
        <header>
            <nav>
                <div class="lg">
                    <a class="logo" href="#">杜と星の日記帳</a>
                </div>
                <div class="global-nav">
                    <ul class="global-nav-ul">
                        <li class="home">
                            <a href="/index.html">ホーム</a>
                        </li>
        
                        <li class="blog">
                            <a href="/blog.html">ブログ</a>
                        </li>
        
                        <li class="contact">
                            <a href="/contact.html">お問い合わせ</a>
                        </li>
                    </ul>
                </div>
            </nav>
        </header>
    
        <main id="content">
            <div class="bg">
                <div class="base">
                    <h2>自宅鯖でブログを公開してみた話</h2>
                    <h3>自宅鯖に興味を持ったキッカケ</h3>
                    <p>こんにちは、星空です。今回、初めて自宅鯖使ってブログを公開しました。これまでの私は、鯖という鯖を持ったことがありませんでした。こうしてブログを書く人なら、誰もが使ったことがある、無料のレンタルサーバを借りて、更新していました。</p>
                    <br>   
                    <p>当時の私は、webデザインの基礎の基礎しか理解しておらず、サイトの大半がコピペで成り立っていました。そのため、凝ったものを作ろうとしたとき、環境がぐちゃぐちゃになることは当たり前。そんなこんなで、当時私が身につけた知識を使って、今ブログを公開しています。ただし、決定的に違うのは、<strong>自宅鯖</strong>を使っていること。</p>
                    <br>
                    <p>何を言っているのか自分でもよくわかっていません。普通、きちんとしたサイトを公開するとしたら、有料のレンタルサーバかVPSを借りると思うんです。私の場合、基礎を一通り学び終わった後、「じゃあ鯖はどうしようか」と思い、調べていたら一つの動画に目が留まりました。<br>「自宅鯖ってなんだろう。」</p>
                    <p>この動画を見たことにより、私の自宅鯖人生が始まりました。</p>

                    <h3>本題</h3>
                    <p>今回は中古で落札した、型落ちのラックマウント鯖を使用してwebサーバを建てました。</p>
                    <p>サーバOSにはKubuntu 22.04 LTSを使用しました。OSのリソースを最小限にしたくて、最初のころはUbuntu Serverを使ってましたが、ゲーム鯖を建てるにあたって、CUIでは少々不便な所があったため、GUIに乗り換えています。</p>
                    <img src="/sozai/Screenshot_20240417_051309.png" alt="Kubuntu-neofetch">
                    <p>webサイトを公開するにあたっては、サーバソフトにnginxを使用しました。ポート開放ができる環境であれば、nginxの設定を終えたら、ポート開放して終わりだと思いますが、今回はZero Trust Tunnelを使用しました。</p>
                    <h3>Zero Trust Tunnelって何ぞ</h3>
                    <p>私の認識では、cloudflareはドメインをプロキシして、CDNを提供するものだと思っていました。なので、これを知らなかったら、別の方法を使っていたかレンタルしていたと思います。(教えてくれたフレンド、感謝)</p>
                    <br>
                    <blockquote cite="https://www.cloudflare.com/ja-jp/products/tunnel/" class="inyou">
                        <p>
                            開発者やIT部門は、アプリケーションが展開された瞬間から、ACLの設定、IPアドレスのローテーション、GREトンネルのような使いにくいソリューションを使用しながら、アプリケーションのロックダウンに時間を費やします。

                            そこで、よりシンプルで安全に、お客様のアプリケーションやWebサーバーを直接攻撃から保護する手段があります。それがCloudflare Tunnelです。
    
                            パブリッククラウド、プライベートクラウド、Kubernetesクラスター、またはTV経由のMacミニなど、どこで実行していようともサーバーの安全を確保します。
                        </p>
                        <footer class="ft-inyou">cloudflare社公式サイトより引用 | <cite>https://www.cloudflare.com/ja-jp/products/tunnel/</cite></footer>
                    </blockquote>
                    <p>公式による説明、一通り読んだけど、なんとなく分かった。要は、SSHポートフォワーディングに似てるのかな。</p>
                    <h3>実際に使ってみる</h3>
                    <img src="/sozai/2024-04-17 055858.png">
                    <p>ログインするとこの画面になるので、左側のZero Trustからアカウント画面に入る。アカウントを作らないとホーム画面には進めない。</p>
                    <img src="/sozai/2024-04-17 060022.png">
                    <p>この場合、もう既にトンネルがあるが、新規で作りたいときは、Create a tunnelをクリックすれば作れる。</p>
                    <img src="/sozai/2024-04-17 060745.png">
                    <p>新規で作って、いろいろ入力すると、この画面になる。ここでcloudflaredをインストールしろという指示が出るので、使っているOSに合わせて選択する。ここでは、Kubuntuを使用しているので、Debianを選択する。</p>
                    <p>アーキテクチャは使用しているマシンによって異なる。大抵のサーバやマシンであれば、64bitだが、古い機種では32bitだったりする。また、RasberryPiやintel以外のチップを載せたMacではARMに属する。</p>
                    <p>すべてを選択し終わると、下のほうにコマンドとトークンが書かれた文字列が発行される。これを、各々のターミナルで実行することで接続する準備が万端になる。</p>
                    <img src="/sozai/2024-04-17 061756.png">
                    <p>ここでいよいよサーバを公開する段階に入る。今回はPublicを使う。サブドメインはオプションなので、使用しなくても問題ない。</p>
                    <p>Domainには登録してあるドメインから選択するか、入力する。Typeでは様々なプロトコルを選択することができる。今回は、webサイトなのでHTTPを選択した。</p>
                    <p>URLには公開したいプロセスのURLを入力する。webサイトの場合はlocalhostだけでよいが、他のサービスの場合はポート番号も入力する必要がある。</p>
                    <p>すべて入力し、保存した後にZero Trustの画面に戻ると、正しく動いている場合には右側にHEALTHYと緑色になっているはず。</p>
                    <h3>nginxの設定と公開</h3>
                    <p>いまのままではサイトを公開できない。公開するにはwebサーバソフトを使う必要がある。</p>
                    <p>updateとupgradeをし、インストールする。</p>
                    <pre>
                        <code class="languages-bash">
                            sudo apt update && sudo apt upgrade -y
                            sudo apt install nginx -y
                        </code>
                    </pre>
                    <p>インストールされたら正常に起動しているか確認する。</p>
                    <pre>
                        <code class="languages-bash">
                            sudo systemctl status nginx
                        </code>
                    </pre>
                    <p>Active(loaded)となっていたら正常稼働しているので次に進む。nginxの設定ファイルは"/etc/nginx/nginx.conf"にあるので、nanoやvimで編集する。</p>
                    <pre>
                        <code class="languages-bash">
                            sudo nano /etc/nginx/nginx.conf
                        </code>
                    </pre>
                    <p>中身を開くと、いろいろ書いてあるので、以下の設定を書き込む。</p>
                    <pre>
                        <code class="languages-bash">
                            http{
                                server{
                                    localhost 80;

                                    localhost_name localhost www.example.com;

                                    rocation / {
                                        root "公開したいファイルまでのルートパス"
                                    }
                                }
                            }
                        </code>
                    </pre>
                    <p>設定が終わったら保存して再起動</p>
                    <pre>
                        <code class="languages-bash">
                            sudo systemctl restart nginx
                        </code>
                    </pre>
                    <p>ようやくここまで来たので、テストファイルなどを配置して、設定したドメインにアクセスしてみる。(写真なし)</p>
                    <p>なんということでしょう。きちんと設定をしたはずなのに、表示されないではありませんか。</p>
                    <br>
                    <p>そうなんです....ここで私はつまづきました。nginxの設定もテストファイルの配置もなにも間違っていないのに、403 Forbiddenが表示される。これを解決するのに、リアルで2時間程度要しました笑</p>
                    <p>結論からいうと、この問題はディレクトリにアクセスできないことが原因です。つまり権限。nginxからログが保存されるはずなので、ログファイルをcatしてみると、やはりPermission deniedとなっています。</p>
                    <p>もし、ファイルを置く場所が間違えていたら403ではなく404が返されます。</p>
                    <br>
                    <p>解決方法は、ルートパスすべてに対して、適切な権限を与える必要があります。これがまた面倒で、パスが"/home/web"だとすると、"chmod xxx(xは整数) /home/web"としても、権限を与えたことにならないということ。</p>
                    <p>どういうことかというと、nginxがパスにアクセスできるようにするには、すべてのパスに対して与える必要があるということ。つまり、"/","/home","/web","/home/web"としなければならない。いや....めんど！マジでめんどい。</p>
                    <p>権限を与え、キャッシュ削除してからもう一度アクセスしてみると、予想された結果になりました。</p>
                    <br>
                    <p>ちなみに、権限が原因でなくとも403が返される時があります。それはSELinuxを有効化しているときです。この無効化方法を書くとさらに長くなるので割愛します。Kubuntuの場合、最小インストールではSELinuxが最初から入っていないので、考える必要はないかもしれません。</p>
                    <h3>感想</h3>
                    <p>nginxで正常に設定しても、403が返るときは権限を疑う。</p>
                    <p>初めてのwebサーバにしては、そこまで時間が掛からなかったが、つまづくところはあった。何度も試して、解決できた時の安堵感はすごいです笑</p>
                </div>
            </div>
        </main>

        <footer id="bottom">
            <div class="ft-bottom">&copy; 2024　杜と星の日記帳</div>
        </footer>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
    <script>hljs.highlightAll();</script>
  </body>
</html>